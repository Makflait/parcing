<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blogger Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2234;
            --bg-card: #151d2e;
            --bg-card-hover: #1c2740;
            --bg-hover: #243049;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #1e293b;
            --border-light: #2a3a52;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --accent-green: #22c55e;
            --accent-purple: #a78bfa;
            --accent-orange: #f59e0b;
            --youtube: #ff0000;
            --tiktok: #00f2ea;
            --instagram: #e4405f;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === Background Effects === */
        .bg-effects {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.07;
            animation: orbFloat 20s ease-in-out infinite;
        }

        .bg-orb-1 {
            width: 600px; height: 600px;
            background: var(--accent);
            top: -200px; right: -100px;
            animation-delay: 0s;
        }

        .bg-orb-2 {
            width: 500px; height: 500px;
            background: var(--accent-purple);
            bottom: -150px; left: -100px;
            animation-delay: -7s;
        }

        .bg-orb-3 {
            width: 400px; height: 400px;
            background: var(--accent-green);
            top: 40%; left: 50%;
            animation-delay: -14s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -40px) scale(1.05); }
            66% { transform: translate(-20px, 30px) scale(0.95); }
        }

        .bg-grid {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
            background-size: 60px 60px;
        }

        /* === Animations === */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-16px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes countUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .fade-in { animation: fadeIn 0.4s ease-out; }

        /* === Layout === */
        .app { display: flex; min-height: 100vh; position: relative; z-index: 1; }

        /* === Sidebar === */
        .sidebar {
            width: 260px;
            background: rgba(17,24,39,0.85);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }

        .logo { display: flex; align-items: center; gap: 12px; }

        .logo-icon {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-purple) 100%);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: white;
        }

        .logo-text { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; }

        .sidebar-nav { padding: 12px 8px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; }

        .nav-section { margin-bottom: 20px; }
        .nav-section.mt-auto { margin-top: auto; }

        .nav-label {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); padding: 0 12px; margin-bottom: 6px; letter-spacing: 1px;
        }

        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 12px; border-radius: 8px;
            color: var(--text-secondary); cursor: pointer;
            transition: all 0.15s ease; font-size: 13px; font-weight: 500; margin-bottom: 1px;
        }

        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }

        .nav-item.active {
            background: rgba(59,130,246,0.12); color: var(--accent-light);
            font-weight: 600;
        }

        .nav-item i { width: 18px; font-size: 13px; text-align: center; }

        .blogger-list { margin-top: 4px; }

        .blogger-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; border-radius: 8px; cursor: pointer;
            transition: all 0.15s ease; margin-bottom: 2px;
        }

        .blogger-item:hover { background: var(--bg-tertiary); }
        .blogger-item.parsing { opacity: 0.6; }
        .blogger-item.parsing .blg-avatar { animation: pulse 1.5s infinite; }

        .blg-avatar {
            width: 28px; height: 28px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 11px; color: white;
        }

        .blg-info { flex: 1; min-width: 0; }

        .blg-name {
            font-size: 12px; font-weight: 500; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .blg-meta { display: flex; align-items: center; gap: 6px; margin-top: 1px; }

        .blg-count { font-size: 10px; color: var(--text-muted); }

        .p-dot { width: 5px; height: 5px; border-radius: 50%; }
        .p-dot.youtube { background: var(--youtube); }
        .p-dot.tiktok { background: var(--tiktok); }
        .p-dot.instagram { background: var(--instagram); }

        /* === Main === */
        .main { flex: 1; margin-left: 260px; min-height: 100vh; }

        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 24px;
            background: rgba(17,24,39,0.6);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 50;
        }

        .topbar-title { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
        .topbar-actions { display: flex; align-items: center; gap: 10px; }

        .update-time { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-muted); }

        /* === Buttons === */
        .btn {
            padding: 7px 14px; border: none; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; gap: 6px;
            transition: all 0.15s ease; font-family: inherit;
        }

        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-primary {
            background: var(--accent); color: white;
            box-shadow: 0 2px 8px rgba(59,130,246,0.3);
        }
        .btn-primary:hover { box-shadow: 0 4px 16px rgba(59,130,246,0.4); background: var(--accent-light); }

        .btn-ghost {
            background: transparent; color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-light); }

        .btn-danger { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.2); }
        .btn-danger:hover { background: rgba(239,68,68,0.2); }

        .btn.loading { pointer-events: none; opacity: 0.6; }

        .btn .spinner {
            width: 12px; height: 12px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }

        /* === Content === */
        .content { padding: 20px 24px; }

        /* === Metric Cards (RevenueCat/Adapty style) === */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }

        .m-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 18px;
            position: relative; overflow: hidden;
            transition: all 0.2s ease;
        }

        .m-card:hover {
            border-color: var(--border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .m-card-label {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px;
        }

        .m-card-value {
            font-size: 26px; font-weight: 800; letter-spacing: -1px;
            color: var(--text-primary); line-height: 1.1;
            animation: countUp 0.4s ease-out;
        }

        .m-card-sub {
            font-size: 11px; color: var(--text-muted); margin-top: 6px;
            display: flex; align-items: center; gap: 4px;
        }

        .m-card-sub .up { color: var(--success); }
        .m-card-sub .down { color: var(--danger); }

        .m-card-icon {
            position: absolute; top: 14px; right: 14px;
            font-size: 20px; opacity: 0.08;
        }

        .m-card.accent { border-top: 2px solid var(--accent); }
        .m-card.green { border-top: 2px solid var(--accent-green); }
        .m-card.purple { border-top: 2px solid var(--accent-purple); }
        .m-card.orange { border-top: 2px solid var(--accent-orange); }

        /* === Platform Cards === */
        .plat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }

        .plat-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 16px;
            display: flex; align-items: center; gap: 14px;
            transition: all 0.2s ease;
        }

        .plat-card:hover { border-color: var(--border-light); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.15); }

        .plat-card.youtube { border-left: 3px solid var(--youtube); }
        .plat-card.tiktok { border-left: 3px solid var(--tiktok); }
        .plat-card.instagram { border-left: 3px solid var(--instagram); }

        .plat-icon {
            width: 42px; height: 42px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        .plat-card.youtube .plat-icon { background: rgba(255,0,0,0.1); color: var(--youtube); }
        .plat-card.tiktok .plat-icon { background: rgba(0,242,234,0.1); color: var(--tiktok); }
        .plat-card.instagram .plat-icon { background: rgba(228,64,95,0.1); color: var(--instagram); }

        .plat-info { flex: 1; }
        .plat-name { font-size: 13px; font-weight: 600; margin-bottom: 3px; }
        .plat-stats { display: flex; gap: 14px; font-size: 11px; color: var(--text-secondary); }
        .plat-stats strong { color: var(--text-primary); }

        /* === Charts === */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 16px; margin-bottom: 20px;
        }

        .chart-box {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
            transition: all 0.2s ease;
        }

        .chart-box:hover { border-color: var(--border-light); }

        .chart-title {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }

        .chart-title i { font-size: 14px; opacity: 0.5; }

        .chart-area { position: relative; width: 100%; height: 280px; }

        /* === Blogger Cards === */
        .blg-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 14px;
        }

        .blg-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 18px; cursor: pointer;
            transition: all 0.25s ease; position: relative; overflow: hidden;
        }

        .blg-card:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(0,0,0,0.25); border-color: var(--accent); }
        .blg-card.parsing { opacity: 0.7; }
        .blg-card.parsing::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(59,130,246,0.08), transparent); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

        .blg-card-head { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }

        .blg-card-avatar {
            width: 44px; height: 44px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 16px; color: white;
        }

        .blg-card-info { flex: 1; }
        .blg-card-name { font-size: 15px; font-weight: 700; margin-bottom: 3px; letter-spacing: -0.2px; }
        .blg-card-tags { display: flex; gap: 6px; }

        .p-tag {
            display: flex; align-items: center; gap: 3px;
            padding: 3px 7px; border-radius: 6px; font-size: 10px; font-weight: 600;
        }
        .p-tag.youtube { background: rgba(255,0,0,0.1); color: var(--youtube); }
        .p-tag.tiktok { background: rgba(0,242,234,0.1); color: var(--tiktok); }
        .p-tag.instagram { background: rgba(228,64,95,0.1); color: var(--instagram); }

        .blg-card-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

        .blg-s {
            text-align: center; padding: 10px 8px;
            background: var(--bg-tertiary); border-radius: 8px;
        }

        .blg-s-val { font-size: 16px; font-weight: 800; letter-spacing: -0.5px; }
        .blg-s-lbl { font-size: 9px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; margin-top: 2px; }

        .parsing-badge {
            position: absolute; top: 10px; right: 10px;
            display: flex; align-items: center; gap: 5px;
            padding: 3px 8px; background: rgba(59,130,246,0.15);
            border-radius: 16px; font-size: 10px; color: var(--accent-light); font-weight: 600;
        }
        .parsing-badge i { animation: spin 1s linear infinite; }

        /* === Data Table === */
        .dtable { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .dtable table { width: 100%; border-collapse: collapse; }
        .dtable thead tr { background: var(--bg-tertiary); }
        .dtable th { padding: 10px 14px; text-align: left; font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .dtable td { padding: 10px 14px; border-top: 1px solid var(--border); font-size: 12px; }
        .dtable tbody tr { transition: background 0.1s; }
        .dtable tbody tr:hover { background: var(--bg-tertiary); }
        .dtable .r { text-align: right; }
        .dtable .c { text-align: center; }
        .dtable .b { font-weight: 700; }
        .dtable a { color: var(--text-primary); text-decoration: none; }
        .dtable a:hover { color: var(--accent-light); }

        /* === Metric List === */
        .m-list { padding: 4px 0; }

        .m-list-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .m-list-row:last-child { border-bottom: none; }

        .m-list-label { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text-secondary); }
        .m-list-dot { width: 8px; height: 8px; border-radius: 50%; }
        .m-list-val { font-size: 15px; font-weight: 700; }

        /* === Section Header === */
        .sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .sec-title { font-size: 14px; font-weight: 700; letter-spacing: -0.2px; }

        /* === Modal === */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(6px); display: none;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 14px; width: 100%; max-width: 460px;
            max-height: 90vh; overflow-y: auto; animation: fadeIn 0.25s ease-out;
        }

        .modal-head { display: flex; align-items: center; justify-content: space-between; padding: 18px 20px; border-bottom: 1px solid var(--border); }
        .modal-head h3 { font-size: 16px; font-weight: 700; }

        .modal-x { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 4px; }
        .modal-x:hover { color: var(--text-primary); }

        .modal-body { padding: 18px 20px; }
        .modal-foot { display: flex; justify-content: flex-end; gap: 10px; padding: 14px 20px; border-top: 1px solid var(--border); }

        .fg { margin-bottom: 16px; }
        .fg label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }

        .fi {
            width: 100%; padding: 10px 14px;
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary);
            font-size: 13px; font-family: inherit; transition: all 0.15s;
        }
        .fi:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .fi::placeholder { color: var(--text-muted); }
        .fi-hint { font-size: 10px; color: var(--text-muted); margin-top: 3px; }

        .confirm-body { text-align: center; padding: 24px 20px; }
        .confirm-body i { font-size: 42px; color: var(--danger); margin-bottom: 14px; }
        .confirm-body p { font-size: 13px; color: var(--text-secondary); margin-top: 6px; }

        /* === Toast === */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--bg-secondary); border: 1px solid var(--border);
            border-radius: 10px; padding: 12px 16px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            transform: translateY(80px); opacity: 0;
            transition: all 0.25s ease; z-index: 2000; font-size: 13px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast i { font-size: 16px; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }

        /* === Empty State === */
        .empty { text-align: center; padding: 50px 20px; color: var(--text-muted); }
        .empty i { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
        .empty p { font-size: 13px; margin-bottom: 14px; }

        /* === Loading === */
        .loading-overlay { position: fixed; inset: 0; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        /* === Responsive === */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .metrics-row { grid-template-columns: repeat(2, 1fr); }
            .blg-grid { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="bg-effects">
        <div class="bg-orb bg-orb-1"></div>
        <div class="bg-orb bg-orb-2"></div>
        <div class="bg-orb bg-orb-3"></div>
        <div class="bg-grid"></div>
    </div>

    <div id="loadingOverlay" class="loading-overlay"><div class="loading-spinner"></div></div>

    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
                    <span class="logo-text">Blogger Analytics</span>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-label">Аналитика</div>
                    <div class="nav-item active" data-view="overview" onclick="showOverview()"><i class="fas fa-th-large"></i><span>Обзор</span></div>
                    <div class="nav-item" data-view="metrics" onclick="showMetrics()"><i class="fas fa-chart-bar"></i><span>Метрики</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-label">Управление</div>
                    <div class="nav-item" data-view="bloggers" onclick="showBloggers()"><i class="fas fa-users"></i><span>Блогеры</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-label">Каналы</div>
                    <div id="sidebarBloggers" class="blogger-list"></div>
                </div>
                <div class="nav-section mt-auto">
                    <div class="nav-item" onclick="openAddModal()"><i class="fas fa-plus"></i><span>Добавить блогера</span></div>
                </div>
                <div class="nav-section" id="adminNav" style="display:none;">
                    <div class="nav-label">Админ</div>
                    <div class="nav-item" onclick="location.href='/admin.html'"><i class="fas fa-cog"></i><span>Админ-панель</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Выйти</span></div>
                </div>
            </nav>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="topbar-title" id="pageTitle">Обзор</div>
                <div class="topbar-actions">
                    <span class="update-time" id="updateTime"><i class="fas fa-clock"></i><span>&mdash;</span></span>
                    <button class="btn btn-ghost" id="refreshBtn" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Обновить</button>
                    <button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Добавить</button>
                </div>
            </div>
            <div class="content" id="mainContent"></div>
        </main>
    </div>

    <!-- Add Blogger Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-head"><h3>Добавить блогера</h3><button class="modal-x" onclick="closeAddModal()"><i class="fas fa-times"></i></button></div>
            <form id="addForm" onsubmit="handleAdd(event)">
                <div class="modal-body">
                    <div class="fg"><label>Имя блогера *</label><input class="fi" id="fName" placeholder="Название канала" required></div>
                    <div class="fg"><label>YouTube</label><input class="fi" id="fYt" placeholder="https://youtube.com/@channel"><div class="fi-hint">Ссылка на канал</div></div>
                    <div class="fg"><label>TikTok</label><input class="fi" id="fTt" placeholder="https://tiktok.com/@user"><div class="fi-hint">Ссылка на профиль</div></div>
                    <div class="fg"><label>Instagram</label><input class="fi" id="fIg" placeholder="https://instagram.com/user"><div class="fi-hint">Ссылка на профиль</div></div>
                </div>
                <div class="modal-foot">
                    <button type="button" class="btn btn-ghost" onclick="closeAddModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="addBtn"><span>Добавить</span></button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Blogger Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-head"><h3>Редактировать блогера</h3><button class="modal-x" onclick="closeEditModal()"><i class="fas fa-times"></i></button></div>
            <form id="editForm" onsubmit="handleEdit(event)">
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="fg"><label>Имя блогера *</label><input class="fi" id="eName" required></div>
                    <div class="fg"><label>YouTube</label><input class="fi" id="eYt" placeholder="https://youtube.com/@channel"></div>
                    <div class="fg"><label>TikTok</label><input class="fi" id="eTt" placeholder="https://tiktok.com/@user"></div>
                    <div class="fg"><label>Instagram</label><input class="fi" id="eIg" placeholder="https://instagram.com/user"></div>
                </div>
                <div class="modal-foot">
                    <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal-overlay" id="delModal">
        <div class="modal" style="max-width:380px;">
            <div class="modal-head"><h3>Удалить блогера</h3><button class="modal-x" onclick="closeDelModal()"><i class="fas fa-times"></i></button></div>
            <div class="confirm-body"><i class="fas fa-exclamation-triangle"></i><h3 id="delName">Удалить?</h3><p>Все данные блогера будут удалены.</p></div>
            <div class="modal-foot"><button class="btn btn-ghost" onclick="closeDelModal()">Отмена</button><button class="btn btn-danger" onclick="confirmDel()"><i class="fas fa-trash"></i> Удалить</button></div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMsg"></span></div>

    <script>
    const API = '';
    let S = null; // global stats
    let U = null; // current user
    let parsing = new Set();
    let charts = {};
    let delId = null;
    const C = ['#3b82f6','#a78bfa','#22c55e','#f59e0b','#ef4444','#ec4899','#06b6d4','#8b5cf6'];
    const PC = {youtube:'#ff0000',tiktok:'#00f2ea',instagram:'#e4405f'};

    // ===== AUTH =====
    const tok = () => localStorage.getItem('access_token');
    const hdr = () => ({'Content-Type':'application/json','Authorization':`Bearer ${tok()}`});

    async function checkAuth() {
        if (!tok()) return location.href='/login.html';
        try {
            const r = await fetch(`${API}/api/auth/me`,{headers:hdr()});
            if (!r.ok) throw 0;
            U = (await r.json()).user;
            if (U.role==='admin') document.getElementById('adminNav').style.display='block';
            await loadData();
        } catch(e) { localStorage.clear(); location.href='/login.html'; }
    }

    function logout() { localStorage.clear(); location.href='/login.html'; }

    // ===== DATA =====
    async function loadData() {
        try {
            const r = await fetch(`${API}/api/stats`,{headers:hdr()});
            if (!r.ok) throw 0;
            S = await r.json();
            updateSidebar();
            showOverview();
            updTime();
        } catch(e) { toast('Ошибка загрузки','error'); }
        finally { document.getElementById('loadingOverlay').style.display='none'; }
    }

    async function refreshData() {
        const b=document.getElementById('refreshBtn');
        b.classList.add('loading'); b.innerHTML='<div class="spinner"></div> ...';
        try {
            await fetch(`${API}/api/parser/start`,{method:'POST',headers:hdr()});
            let run=true;
            while(run){await new Promise(r=>setTimeout(r,2000));const s=await(await fetch(`${API}/api/parser/status`,{headers:hdr()})).json();run=s.running;}
            await loadData(); toast('Данные обновлены!');
        } catch(e){toast('Ошибка','error');}
        finally{b.classList.remove('loading');b.innerHTML='<i class="fas fa-sync-alt"></i> Обновить';}
    }

    // ===== SIDEBAR =====
    function updateSidebar() {
        const el=document.getElementById('sidebarBloggers');
        const bl=S?.bloggers||[];
        if(!bl.length){el.innerHTML='<div style="padding:10px 12px;color:var(--text-muted);font-size:11px;">Нет блогеров</div>';return;}
        el.innerHTML=bl.map((b,i)=>{
            const p=[];if(b.youtube)p.push('youtube');if(b.tiktok)p.push('tiktok');if(b.instagram)p.push('instagram');
            return`<div class="blogger-item${parsing.has(b.id)?' parsing':''}" onclick="showDetail(${b.id})">
                <div class="blg-avatar" style="background:${C[i%C.length]}">${b.name[0].toUpperCase()}</div>
                <div class="blg-info"><div class="blg-name">${b.name}</div>
                <div class="blg-meta"><span class="blg-count">${fmtN(b.views||0)}</span><div style="display:flex;gap:3px">${p.map(x=>`<div class="p-dot ${x}"></div>`).join('')}</div></div></div></div>`;
        }).join('');
    }

    // ===== OVERVIEW =====
    function showOverview() {
        destroyCharts();
        document.getElementById('pageTitle').textContent='Обзор';
        setNav('overview');
        const s=S||{},bl=s.bloggers||[],pl=s.platforms||{};
        const avgV=s.avg_views||0,er=s.engagement||0;

        const mc=document.getElementById('mainContent');
        mc.innerHTML=`<div class="fade-in">
            <div class="metrics-row">
                <div class="m-card accent"><div class="m-card-label">Всего видео</div><div class="m-card-value">${fmtN(s.total_videos||0)}</div><div class="m-card-sub">${bl.length} блогеров</div><i class="fas fa-video m-card-icon"></i></div>
                <div class="m-card green"><div class="m-card-label">Просмотры</div><div class="m-card-value">${fmtN(s.total_views||0)}</div><div class="m-card-sub">~${fmtN(avgV)} / видео</div><i class="fas fa-eye m-card-icon"></i></div>
                <div class="m-card purple"><div class="m-card-label">Лайки</div><div class="m-card-value">${fmtN(s.total_likes||0)}</div><div class="m-card-sub">ER ${er}%</div><i class="fas fa-heart m-card-icon"></i></div>
                <div class="m-card orange"><div class="m-card-label">Комментарии</div><div class="m-card-value">${fmtN(s.total_comments||0)}</div><div class="m-card-sub">активность аудитории</div><i class="fas fa-comments m-card-icon"></i></div>
            </div>
            ${renderPlatforms(pl)}
            <div class="sec-head"><h3 class="sec-title">Блогеры</h3></div>
            ${bl.length===0?`<div class="empty"><i class="fas fa-user-plus"></i><p>Добавьте первого блогера</p><button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Добавить</button></div>`
            :`<div class="blg-grid">${bl.map((b,i)=>renderCard(b,i)).join('')}</div>`}
        </div>`;
    }

    function renderPlatforms(pl) {
        let h='';
        if(pl.youtube?.videos>0)h+=`<div class="plat-card youtube"><div class="plat-icon"><i class="fab fa-youtube"></i></div><div class="plat-info"><div class="plat-name">YouTube</div><div class="plat-stats"><div><strong>${fmtN(pl.youtube.videos)}</strong> видео</div><div><strong>${fmtN(pl.youtube.views)}</strong> просмотров</div></div></div></div>`;
        if(pl.tiktok?.videos>0)h+=`<div class="plat-card tiktok"><div class="plat-icon"><i class="fab fa-tiktok"></i></div><div class="plat-info"><div class="plat-name">TikTok</div><div class="plat-stats"><div><strong>${fmtN(pl.tiktok.videos)}</strong> видео</div><div><strong>${fmtN(pl.tiktok.views)}</strong> просмотров</div></div></div></div>`;
        if(pl.instagram?.videos>0)h+=`<div class="plat-card instagram"><div class="plat-icon"><i class="fab fa-instagram"></i></div><div class="plat-info"><div class="plat-name">Instagram</div><div class="plat-stats"><div><strong>${fmtN(pl.instagram.videos)}</strong> видео</div><div><strong>${fmtN(pl.instagram.views)}</strong> просмотров</div></div></div></div>`;
        return h?`<div class="plat-grid">${h}</div>`:'';
    }

    function renderCard(b,i) {
        const ip=parsing.has(b.id);
        const pl=[];
        if(b.youtube)pl.push({i:'fab fa-youtube',c:'youtube'});
        if(b.tiktok)pl.push({i:'fab fa-tiktok',c:'tiktok'});
        if(b.instagram)pl.push({i:'fab fa-instagram',c:'instagram'});
        return`<div class="blg-card${ip?' parsing':''}" onclick="showDetail(${b.id})" style="animation:fadeIn 0.3s ease ${i*0.05}s both">
            ${ip?'<div class="parsing-badge"><i class="fas fa-spinner"></i> Парсинг...</div>':''}
            <div class="blg-card-head">
                <div class="blg-card-avatar" style="background:${C[i%C.length]}">${b.name[0].toUpperCase()}</div>
                <div class="blg-card-info"><div class="blg-card-name">${b.name}</div><div class="blg-card-tags">${pl.map(p=>`<span class="p-tag ${p.c}"><i class="${p.i}"></i></span>`).join('')}</div></div>
            </div>
            <div class="blg-card-stats">
                <div class="blg-s"><div class="blg-s-val">${fmtN(b.videos||0)}</div><div class="blg-s-lbl">Видео</div></div>
                <div class="blg-s"><div class="blg-s-val">${fmtN(b.views||0)}</div><div class="blg-s-lbl">Просмотры</div></div>
                <div class="blg-s"><div class="blg-s-val">${b.engagement||0}%</div><div class="blg-s-lbl">ER</div></div>
            </div></div>`;
    }

    // ===== METRICS (UBT) =====
    function showMetrics() {
        destroyCharts();
        document.getElementById('pageTitle').textContent='Метрики';
        setNav('metrics');
        const s=S||{},bl=s.bloggers||[],pl=s.platforms||{};
        if(!bl.length){document.getElementById('mainContent').innerHTML=`<div class="fade-in"><div class="empty"><i class="fas fa-chart-pie"></i><p>Добавьте блогеров для метрик</p><button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Добавить</button></div></div>`;return;}

        // UBT metrics calculations
        const totalV=s.total_views||0, totalL=s.total_likes||0, totalC=s.total_comments||0, totalVid=s.total_videos||0;
        const er=totalV>0?((totalL/totalV)*100).toFixed(2):0;
        const cr=totalV>0?((totalC/totalV)*100).toFixed(3):0; // Comment Rate
        const avgViews=totalVid>0?Math.round(totalV/totalVid):0;
        const lcr=totalL>0?(totalC/totalL).toFixed(2):0; // Likes-to-Comments ratio
        const virality=totalV>0?(((totalL+totalC)/totalV)*100).toFixed(2):0; // Virality index

        // Per-platform data
        const pLabels=[],pViews=[],pVids=[],pColors=[];
        for(const k of['youtube','tiktok','instagram']){if(pl[k]?.views>0){pLabels.push(k[0].toUpperCase()+k.slice(1));pViews.push(pl[k].views);pVids.push(pl[k].videos);pColors.push(PC[k]);}}

        // Top bloggers
        const top=[...bl].sort((a,b)=>b.views-a.views).slice(0,10);
        const topN=top.map(b=>b.name.length>18?b.name.slice(0,18)+'…':b.name);
        const topV=top.map(b=>b.views);

        // Engagement leaderboard
        const engBl=[...bl].filter(b=>b.engagement>0).sort((a,b)=>b.engagement-a.engagement).slice(0,10);

        // Avg views per platform
        const avgPP={};
        for(const k of['youtube','tiktok','instagram']){if(pl[k]?.videos>0)avgPP[k]=Math.round(pl[k].views/pl[k].videos);}

        const mc=document.getElementById('mainContent');
        mc.innerHTML=`<div class="fade-in">
            <div class="metrics-row">
                <div class="m-card accent"><div class="m-card-label">Avg Views</div><div class="m-card-value">${fmtN(avgViews)}</div><div class="m-card-sub">средний просмотр на видео</div><i class="fas fa-chart-line m-card-icon"></i></div>
                <div class="m-card green"><div class="m-card-label">ER (Engagement)</div><div class="m-card-value">${er}%</div><div class="m-card-sub">лайки / просмотры</div><i class="fas fa-fire m-card-icon"></i></div>
                <div class="m-card purple"><div class="m-card-label">CR (Comment Rate)</div><div class="m-card-value">${cr}%</div><div class="m-card-sub">комментарии / просмотры</div><i class="fas fa-comment m-card-icon"></i></div>
                <div class="m-card orange"><div class="m-card-label">Virality Index</div><div class="m-card-value">${virality}%</div><div class="m-card-sub">(лайки+комменты) / просмотры</div><i class="fas fa-bolt m-card-icon"></i></div>
            </div>
            <div class="metrics-row">
                <div class="m-card"><div class="m-card-label">L/C Ratio</div><div class="m-card-value">${lcr}</div><div class="m-card-sub">лайков на 1 комментарий</div></div>
                <div class="m-card"><div class="m-card-label">Всего контента</div><div class="m-card-value">${fmtN(totalVid)}</div><div class="m-card-sub">${bl.length} блогеров</div></div>
                <div class="m-card"><div class="m-card-label">Лучший блогер</div><div class="m-card-value" style="font-size:18px">${top[0]?.name||'-'}</div><div class="m-card-sub">${fmtN(top[0]?.views||0)} просмотров</div></div>
                <div class="m-card"><div class="m-card-label">Платформ</div><div class="m-card-value">${pLabels.length}</div><div class="m-card-sub">активных каналов</div></div>
            </div>

            <div class="charts-row">
                <div class="chart-box"><div class="chart-title"><i class="fas fa-chart-pie"></i> Распределение просмотров</div><div class="chart-area"><canvas id="chPlatViews"></canvas></div></div>
                <div class="chart-box"><div class="chart-title"><i class="fas fa-chart-bar"></i> Топ по просмотрам</div><div class="chart-area"><canvas id="chTopBlog"></canvas></div></div>
            </div>
            <div class="charts-row">
                <div class="chart-box"><div class="chart-title"><i class="fas fa-fire"></i> ER по блогерам</div><div class="chart-area"><canvas id="chER"></canvas></div></div>
                <div class="chart-box"><div class="chart-title"><i class="fas fa-video"></i> Контент по платформам</div><div class="chart-area"><canvas id="chPlatVids"></canvas></div></div>
            </div>

            ${Object.keys(avgPP).length?`<div class="chart-box" style="margin-bottom:20px"><div class="chart-title"><i class="fas fa-tachometer-alt"></i> Avg Views по платформам</div>
                <div class="m-list">${Object.entries(avgPP).map(([k,v])=>`<div class="m-list-row"><div class="m-list-label"><span class="m-list-dot" style="background:${PC[k]}"></span><i class="fab fa-${k}" style="color:${PC[k]};width:18px"></i>${k[0].toUpperCase()+k.slice(1)}</div><div class="m-list-val">${fmtN(v)}</div></div>`).join('')}</div></div>`:''}

            <div class="chart-box"><div class="chart-title"><i class="fas fa-table"></i> Детализация</div>
                <div class="dtable" style="border:none"><table><thead><tr><th>Блогер</th><th class="c">Платформы</th><th class="r">Видео</th><th class="r">Просмотры</th><th class="r">ER</th><th class="r">CR</th></tr></thead><tbody>
                ${bl.map(b=>{const ps=[];if(b.youtube)ps.push('<i class="fab fa-youtube" style="color:var(--youtube)"></i>');if(b.tiktok)ps.push('<i class="fab fa-tiktok" style="color:var(--tiktok)"></i>');if(b.instagram)ps.push('<i class="fab fa-instagram" style="color:var(--instagram)"></i>');
                const bcr=b.views>0?((b.comments||0)/b.views*100).toFixed(3):0;
                return`<tr style="cursor:pointer" onclick="showDetail(${b.id})"><td class="b">${b.name}</td><td class="c" style="font-size:14px;display:flex;gap:6px;justify-content:center">${ps.join('')}</td><td class="r">${fmtN(b.videos||0)}</td><td class="r b">${fmtN(b.views||0)}</td><td class="r">${b.engagement||0}%</td><td class="r">${bcr}%</td></tr>`;}).join('')}
                </tbody></table></div></div>
        </div>`;

        requestAnimationFrame(()=>{
            Chart.defaults.color='#64748b';Chart.defaults.borderColor='#1e293b';
            if(pLabels.length){charts.pv=new Chart(document.getElementById('chPlatViews'),{type:'doughnut',data:{labels:pLabels,datasets:[{data:pViews,backgroundColor:pColors.map(c=>c+'cc'),borderColor:'#151d2e',borderWidth:3,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{padding:16,font:{size:12,family:'Inter'}}},tooltip:{callbacks:{label:ctx=>{const t=ctx.dataset.data.reduce((a,b)=>a+b,0);return`${ctx.label}: ${fmtN(ctx.raw)} (${((ctx.raw/t)*100).toFixed(1)}%)`;}}}}}})}
            if(topN.length){charts.tb=new Chart(document.getElementById('chTopBlog'),{type:'bar',data:{labels:topN,datasets:[{data:topV,backgroundColor:top.map((_,i)=>C[i%C.length]+'88'),borderColor:top.map((_,i)=>C[i%C.length]),borderWidth:1,borderRadius:4,barPercentage:0.7}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmtN(ctx.raw)+' просмотров'}}},scales:{x:{grid:{color:'rgba(30,41,59,0.5)'},ticks:{callback:v=>fmtN(v),font:{family:'Inter'}}},y:{grid:{display:false},ticks:{font:{family:'Inter',size:11}}}}}})}
            if(engBl.length){charts.er=new Chart(document.getElementById('chER'),{type:'bar',data:{labels:engBl.map(b=>b.name.length>18?b.name.slice(0,18)+'…':b.name),datasets:[{data:engBl.map(b=>b.engagement),backgroundColor:'rgba(167,139,250,0.5)',borderColor:'#a78bfa',borderWidth:1,borderRadius:4,barPercentage:0.7}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>ctx.raw+'%'}}},scales:{x:{grid:{display:false},ticks:{font:{family:'Inter',size:10},maxRotation:45}},y:{grid:{color:'rgba(30,41,59,0.5)'},ticks:{callback:v=>v+'%',font:{family:'Inter'}}}}}})}
            if(pLabels.length){charts.pvd=new Chart(document.getElementById('chPlatVids'),{type:'bar',data:{labels:pLabels,datasets:[{data:pVids,backgroundColor:pColors.map(c=>c+'88'),borderColor:pColors,borderWidth:1,borderRadius:6,barPercentage:0.5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{color:'rgba(30,41,59,0.5)'}}}}})}
        });
    }

    // ===== BLOGGERS TAB =====
    function showBloggers() {
        destroyCharts();
        document.getElementById('pageTitle').textContent='Блогеры';
        setNav('bloggers');
        const bl=S?.bloggers||[];
        const mc=document.getElementById('mainContent');
        if(!bl.length){mc.innerHTML=`<div class="fade-in"><div class="empty"><i class="fas fa-users"></i><p>Нет блогеров</p><button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Добавить</button></div></div>`;return;}

        mc.innerHTML=`<div class="fade-in">
            <div class="sec-head"><h3 class="sec-title">Управление блогерами (${bl.length})</h3><button class="btn btn-primary" onclick="openAddModal()"><i class="fas fa-plus"></i> Добавить</button></div>
            <div class="dtable"><table><thead><tr>
                <th>Блогер</th><th>YouTube</th><th>TikTok</th><th>Instagram</th><th class="r">Видео</th><th class="r">Просмотры</th><th class="c">Действия</th>
            </tr></thead><tbody>
            ${bl.map((b,i)=>`<tr>
                <td><div style="display:flex;align-items:center;gap:10px">
                    <div class="blg-avatar" style="background:${C[i%C.length]};width:30px;height:30px;border-radius:8px;font-size:11px">${b.name[0].toUpperCase()}</div>
                    <strong>${b.name}</strong></div></td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:var(--text-muted)">${b.youtube||'<span style="opacity:0.3">—</span>'}</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:var(--text-muted)">${b.tiktok||'<span style="opacity:0.3">—</span>'}</td>
                <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:11px;color:var(--text-muted)">${b.instagram||'<span style="opacity:0.3">—</span>'}</td>
                <td class="r b">${fmtN(b.videos||0)}</td>
                <td class="r b">${fmtN(b.views||0)}</td>
                <td class="c"><div style="display:flex;gap:6px;justify-content:center">
                    <button class="btn btn-ghost" style="padding:5px 8px" onclick="event.stopPropagation();openEditModal(${b.id})" title="Редактировать"><i class="fas fa-edit" style="font-size:12px"></i></button>
                    <button class="btn btn-ghost" style="padding:5px 8px" onclick="event.stopPropagation();parseBlogger(${b.id})" title="Обновить данные"><i class="fas fa-sync-alt" style="font-size:12px"></i></button>
                    <button class="btn btn-danger" style="padding:5px 8px" onclick="event.stopPropagation();openDelModal(${b.id},'${b.name.replace(/'/g,"\\'")}')" title="Удалить"><i class="fas fa-trash" style="font-size:12px"></i></button>
                </div></td>
            </tr>`).join('')}
            </tbody></table></div>
        </div>`;
    }

    // ===== DETAIL =====
    async function showDetail(id) {
        document.getElementById('loadingOverlay').style.display='flex';
        destroyCharts();
        try {
            const r=await fetch(`${API}/api/blogger/${id}`,{headers:hdr()});
            if(!r.ok)throw 0;
            const d=await r.json();
            document.getElementById('pageTitle').textContent=d.name;
            setNav(null);
            const pl=d.platforms||{};
            const dpL=[],dpV=[],dpC=[];
            for(const k of['youtube','tiktok','instagram']){if(pl[k]?.views>0){dpL.push(k[0].toUpperCase()+k.slice(1));dpV.push(pl[k].views);dpC.push(PC[k]);}}

            const mc=document.getElementById('mainContent');
            mc.innerHTML=`<div class="fade-in">
                ${renderPlatforms(pl)}
                <div class="charts-row">
                    <div class="chart-box"><div class="chart-title">Статистика</div>
                        <div class="metrics-row" style="margin:0">
                            <div class="m-card accent" style="margin:0"><div class="m-card-label">Видео</div><div class="m-card-value">${fmtN(d.total_videos||0)}</div></div>
                            <div class="m-card green" style="margin:0"><div class="m-card-label">Просмотры</div><div class="m-card-value">${fmtN(d.total_views||0)}</div></div>
                            <div class="m-card purple" style="margin:0"><div class="m-card-label">Лайки</div><div class="m-card-value">${fmtN(d.total_likes||0)}</div></div>
                        </div>
                    </div>
                    ${dpL.length>1?`<div class="chart-box"><div class="chart-title">Просмотры по платформам</div><div class="chart-area" style="height:200px"><canvas id="chDetPlat"></canvas></div></div>`:''}
                </div>
                <div class="sec-head"><h3 class="sec-title">Топ видео</h3>
                    <div style="display:flex;gap:6px">
                        <button class="btn btn-ghost" onclick="parseBlogger(${id})"><i class="fas fa-sync-alt"></i> Обновить</button>
                        <button class="btn btn-danger" onclick="openDelModal(${id},'${d.name.replace(/'/g,"\\'")}')"><i class="fas fa-trash"></i> Удалить</button>
                    </div>
                </div>
                ${d.videos?.length?`<div class="dtable"><table><thead><tr><th>Видео</th><th class="c">Платформа</th><th class="r">Просмотры</th><th class="r">Лайки</th></tr></thead><tbody>
                ${d.videos.slice(0,30).map(v=>`<tr><td><a href="${v.url}" target="_blank" rel="noopener">${v.title||'Без названия'}</a></td><td class="c"><span class="p-tag ${v.platform}"><i class="fab fa-${v.platform}"></i></span></td><td class="r b">${fmtN(v.views||0)}</td><td class="r">${fmtN(v.likes||0)}</td></tr>`).join('')}
                </tbody></table></div>`:`<div class="empty"><i class="fas fa-video-slash"></i><p>Видео не загружены</p><button class="btn btn-primary" onclick="parseBlogger(${id})"><i class="fas fa-download"></i> Загрузить</button></div>`}
            </div>`;

            if(dpL.length>1){requestAnimationFrame(()=>{charts.dp=new Chart(document.getElementById('chDetPlat'),{type:'doughnut',data:{labels:dpL,datasets:[{data:dpV,backgroundColor:dpC.map(c=>c+'bb'),borderColor:'#151d2e',borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{padding:12,font:{size:11,family:'Inter'}}},tooltip:{callbacks:{label:ctx=>{const t=ctx.dataset.data.reduce((a,b)=>a+b,0);return`${ctx.label}: ${fmtN(ctx.raw)} (${((ctx.raw/t)*100).toFixed(1)}%)`;}}}}}});});}
        } catch(e){toast('Ошибка загрузки','error');}
        finally{document.getElementById('loadingOverlay').style.display='none';}
    }

    async function parseBlogger(id) {
        parsing.add(id); updateSidebar(); toast('Парсинг запущен...');
        try{await fetch(`${API}/api/bloggers/${id}/parse`,{method:'POST',headers:hdr()});
            setTimeout(async()=>{parsing.delete(id);await loadData();showDetail(id);toast('Данные обновлены!');},8000);
        }catch(e){parsing.delete(id);toast('Ошибка','error');}
    }

    // ===== MODALS =====
    function openAddModal(){document.getElementById('addModal').classList.add('active');document.getElementById('fName').focus();}
    function closeAddModal(){document.getElementById('addModal').classList.remove('active');document.getElementById('addForm').reset();}

    async function handleAdd(e){
        e.preventDefault();
        const b=document.getElementById('addBtn');b.classList.add('loading');b.innerHTML='<div class="spinner"></div>';
        const data={name:document.getElementById('fName').value.trim(),youtube:document.getElementById('fYt').value.trim(),tiktok:document.getElementById('fTt').value.trim(),instagram:document.getElementById('fIg').value.trim()};
        try{const r=await fetch(`${API}/api/bloggers`,{method:'POST',headers:hdr(),body:JSON.stringify(data)});const res=await r.json();
            if(res.error){toast(res.error,'error');return;}
            if(res.blogger){if(!S.bloggers)S.bloggers=[];S.bloggers.push(res.blogger);parsing.add(res.blogger.id);}
            closeAddModal();updateSidebar();showOverview();toast('Блогер добавлен! Данные загружаются...');
            setTimeout(async()=>{if(res.blogger)parsing.delete(res.blogger.id);await loadData();},12000);
        }catch(e){toast('Ошибка','error');}
        finally{b.classList.remove('loading');b.innerHTML='<span>Добавить</span>';}
    }

    async function openEditModal(id){
        try{const r=await fetch(`${API}/api/blogger/${id}`,{headers:hdr()});const d=await r.json();
            document.getElementById('editId').value=id;
            document.getElementById('eName').value=d.name||'';
            document.getElementById('eYt').value=d.youtube||'';
            document.getElementById('eTt').value=d.tiktok||'';
            document.getElementById('eIg').value=d.instagram||'';
            document.getElementById('editModal').classList.add('active');
        }catch(e){toast('Ошибка','error');}
    }
    function closeEditModal(){document.getElementById('editModal').classList.remove('active');}

    async function handleEdit(e){
        e.preventDefault();
        const id=document.getElementById('editId').value;
        const data={name:document.getElementById('eName').value.trim(),youtube:document.getElementById('eYt').value.trim(),tiktok:document.getElementById('eTt').value.trim(),instagram:document.getElementById('eIg').value.trim()};
        try{const r=await fetch(`${API}/api/bloggers/${id}`,{method:'PUT',headers:hdr(),body:JSON.stringify(data)});const res=await r.json();
            if(res.error){toast(res.error,'error');return;}
            closeEditModal();toast('Блогер обновлён!');await loadData();
        }catch(e){toast('Ошибка','error');}
    }

    function openDelModal(id,name){delId=id;document.getElementById('delName').textContent=`Удалить "${name}"?`;document.getElementById('delModal').classList.add('active');}
    function closeDelModal(){document.getElementById('delModal').classList.remove('active');delId=null;}

    async function confirmDel(){
        if(!delId)return;
        try{const r=await fetch(`${API}/api/bloggers/${delId}`,{method:'DELETE',headers:hdr()});const res=await r.json();
            if(res.success){closeDelModal();toast('Блогер удалён');await loadData();}
            else toast(res.error||'Ошибка','error');
        }catch(e){toast('Ошибка','error');}
    }

    // ===== HELPERS =====
    function destroyCharts(){for(const k of Object.keys(charts)){if(charts[k]){charts[k].destroy();delete charts[k];}}}

    function setNav(v){
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.blogger-item').forEach(e=>e.classList.remove('active'));
        if(v){const n=document.querySelector(`.nav-item[data-view="${v}"]`);if(n)n.classList.add('active');}
    }

    function fmtN(n){if(n>=1e9)return(n/1e9).toFixed(1)+'B';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toString();}

    function updTime(){const d=new Date();document.getElementById('updateTime').innerHTML=`<i class="fas fa-clock"></i><span>${d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}</span>`;}

    function toast(msg,type='success'){const t=document.getElementById('toast');t.className='toast '+type;t.querySelector('i').className=type==='success'?'fas fa-check-circle':'fas fa-exclamation-circle';document.getElementById('toastMsg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded',checkAuth);
    document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeAddModal();closeEditModal();closeDelModal();}if(e.key==='n'&&(e.ctrlKey||e.metaKey)){e.preventDefault();openAddModal();}});
    </script>
</body>
</html>

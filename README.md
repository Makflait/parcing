# Blogger Analytics SaaS Platform v3.0

Multi-user платформа для аналитики блогеров YouTube, TikTok, Instagram с системой обнаружения трендов.

## Новое в v3.0

- **Multi-tenancy** - поддержка множества пользователей
- **Docker** - контейнеризация с PostgreSQL, Redis, Celery
- **JWT Auth** - система аутентификации
- **Admin Panel** - управление пользователями
- **Spy Service** - автоматический мониторинг трендов
- **Velocity Tracking** - отслеживание скорости роста видео

---

## Режимы работы

### 1. Local Mode (разработка)
Работает без Docker, использует SQLite/JSON.

```bash
pip install -r requirements.txt
python web/app.py
```

### 2. Docker Mode (production)
```bash
copy .env.example .env
docker-compose up -d
```

---

## Возможности v2.0

- **Парсинг ВСЕХ видео** с каналов (до 30 видео на блогера)
- **Автообновление статистики** - при повторном запуске обновляет просмотры/лайки существующих видео
- Сбор детальной статистики: просмотры, лайки, комментарии, репосты, дата публикации
- Автоматическое добавление данных в Google Sheets
- **Итоговые отчёты** с топ-блогерами и статистикой по платформам
- **Экспорт в CSV** для анализа в Excel
- Retry-логика для устойчивости к сетевым ошибкам
- Подробное логирование всех операций

## Требования

- Python 3.8 или выше
- Google аккаунт для работы с Google Sheets API
- Chrome/Chromium для Selenium WebDriver
- Стабильное интернет-соединение

## Установка

### 1. Клонирование и установка зависимостей

**Windows (PowerShell/CMD):**
```powershell
# Переход в директорию проекта
cd C:\Users\mgl\parcing

# Установка зависимостей
pip install -r requirements.txt

# Если pip не найден, используйте:
python -m pip install -r requirements.txt
```

**Linux/MacOS:**
```bash
# Переход в директорию проекта
cd /path/to/parcing

# Установка зависимостей
pip install -r requirements.txt
```

### 2. Настройка Google Sheets API

#### Шаг 1: Создание проекта в Google Cloud Console

1. Перейдите на [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите **Google Sheets API**:
   - Перейдите в "APIs & Services" → "Library"
   - Найдите "Google Sheets API"
   - Нажмите "Enable"

#### Шаг 2: Создание Service Account

1. Перейдите в "APIs & Services" → "Credentials"
2. Нажмите "Create Credentials" → "Service Account"
3. Заполните информацию:
   - Service account name: `blogger-stats-parser`
   - Service account ID: (автоматически)
   - Description: `Parser for blogger statistics`
4. Нажмите "Create and Continue"
5. В разделе "Grant this service account access to project" можно пропустить
6. Нажмите "Done"

#### Шаг 3: Создание ключа

1. В списке Service Accounts найдите созданный аккаунт
2. Нажмите на него
3. Перейдите во вкладку "Keys"
4. Нажмите "Add Key" → "Create new key"
5. Выберите формат **JSON**
6. Нажмите "Create"
7. Файл `credentials.json` автоматически скачается
8. **Переместите** этот файл в корень проекта (`parcing/credentials.json`)

#### Шаг 4: Создание Google Sheets таблицы

1. Откройте [Google Sheets](https://sheets.google.com/)
2. Создайте новую таблицу
3. Назовите её `Blogger Stats` (или другое имя, но тогда измените в `config.json`)
4. **Важно:** Откройте файл `credentials.json` и найдите поле `client_email`
5. Скопируйте этот email (например: `blogger-stats-parser@project-id.iam.gserviceaccount.com`)
6. В Google Sheets таблице нажмите "Поделиться" → вставьте скопированный email
7. Дайте права "Редактор"
8. Нажмите "Готово"

### 3. Настройка конфигурации блогеров

Откройте файл `config.json` и добавьте данные своих блогеров:

```json
{
  "spreadsheet_name": "Blogger Stats",
  "bloggers": [
    {
      "name": "Имя Блогера 1",
      "youtube": "https://www.youtube.com/@username",
      "tiktok": "https://www.tiktok.com/@username",
      "instagram": ""
    },
    {
      "name": "Имя Блогера 2",
      "youtube": "https://www.youtube.com/@username2",
      "tiktok": "https://www.tiktok.com/@username2",
      "instagram": ""
    }
  ]
}
```

**Примечания:**
- **Instagram временно отключён** в v2.0 (оставьте пустым)
- Если у блогера нет канала на какой-то платформе, оставьте пустую строку: `"youtube": ""`
- `spreadsheet_name` должен совпадать с названием вашей таблицы в Google Sheets

## Использование

### Запуск парсера

**Windows:**
```powershell
python main.py
```

**Если `python` не найден, попробуйте:**
```powershell
py main.py
# или
python3 main.py
```

**Linux/MacOS:**
```bash
python3 main.py
```

### Что происходит при запуске:

1. Загружается конфигурация блогеров из `config.json`
2. Подключение к Google Sheets
3. Загрузка существующих видео из таблицы
4. Для каждого блогера:
   - Парсинг **ВСЕХ видео** (до 30) с каждой платформы
   - Для существующих видео → **обновление просмотров/лайков**
   - Для новых видео → добавление в таблицу
5. Вывод итогового отчёта с топ-блогерами

### Генерация отчётов

**Полный отчёт:**
```bash
python generate_report.py
```

**Экспорт в CSV:**
```bash
python generate_report.py --export-csv
python generate_report.py --export-csv -o report_2026-01-26.csv
```

**Отчёт по конкретному блогеру:**
```bash
python generate_report.py -b "milana.thompson8"
```

### Структура таблицы Google Sheets v2.0

| Блогер | Платформа | Дата публикации | Дата парсинга | Название ролика | URL | Просмотры | Лайки | Комментарии | Репосты | Время просмотра |
|--------|-----------|-----------------|---------------|-----------------|-----|-----------|-------|-------------|---------|-----------------|

**Новое в v2.0:**
- **Дата публикации** - реальная дата публикации видео (не дата парсинга)
- **Дата парсинга** - обновляется при каждом запуске для существующих видео
- Автоматическое обновление колонок G, H, I (просмотры, лайки, комментарии)

## Автоматизация

### Windows (Task Scheduler)

1. Откройте "Планировщик заданий"
2. Нажмите "Создать простую задачу"
3. Название: `Blogger Stats Parser`
4. Триггер: "Ежедневно"
5. Время: например, 10:00 и 22:00
6. Действие: "Запустить программу"
7. Программа: путь к Python (например: `C:\Python311\python.exe`)
8. Аргументы: `main.py`
9. Рабочая папка: путь к проекту (например: `C:\Users\mgl\parcing`)
10. Нажмите "Готово"

### Linux/MacOS (cron)

```bash
# Откройте crontab для редактирования
crontab -e

# Добавьте строку (запуск каждый день в 10:00 и 22:00)
0 10,22 * * * cd /path/to/parcing && /usr/bin/python3 main.py >> /path/to/parcing/logs/cron.log 2>&1
```

## Логирование

Все логи сохраняются в директории `logs/`:
- Имя файла: `parser_YYYYMMDD.log`
- Формат: дата, уровень, сообщение

Пример:
```
2026-01-26 19:58:24 - blogger_stats - INFO - Запуск сбора статистики блогеров v2.0
2026-01-26 19:58:29 - blogger_stats - INFO - Загружено 80 существующих видео из таблицы
2026-01-26 20:01:06 - blogger_stats - INFO - Найдено 16 видео на TikTok
2026-01-26 20:16:53 - blogger_stats - INFO - Добавлено новых: 6, Обновлено: 68
```

## Устранение проблем

### YouTube не находит видео

**Симптомы:**
```
YouTube: не найдены видео на странице https://www.youtube.com/@username/videos
```

**Причины:**
1. YouTube блокирует headless браузер
2. Канал не содержит публичных видео
3. Неправильный URL канала

**Решения:**
1. Проверьте URL - должен быть формата `https://www.youtube.com/@username`
2. Убедитесь, что на канале есть публичные видео
3. Попробуйте запустить ещё раз (иногда помогает)
4. Если проблема сохраняется - YouTube может временно блокировать IP

### TikTok timeout ошибки

**Симптомы:**
```
HTTPConnectionPool: Read timed out
```

**Решение:**
- Это нормально для TikTok, парсер продолжит работу
- Видео, которое вызвало timeout, будет пропущено
- При следующем запуске парсер попробует снова

### Google Sheets timeout

**Симптомы:**
```
ERROR - Ошибка обновления видео в строке X: Read timed out
```

**Решение:**
- Парсер автоматически повторит попытку 3 раза
- Если проблема повторяется - проверьте интернет-соединение
- Попробуйте запустить парсер ещё раз

### Ошибка: "Файл credentials не найден"

**Решение:** Убедитесь, что файл `credentials.json` находится в корне проекта.

### Ошибка: "Таблица не найдена"

**Решение:**
1. Проверьте название таблицы в `config.json`
2. Убедитесь, что Service Account имеет доступ к таблице

### Ошибка: "Permission denied" при работе с Google Sheets

**Решение:**
1. Откройте Google Sheets таблицу
2. Нажмите "Поделиться"
3. Добавьте email из `credentials.json` (поле `client_email`)
4. Дайте права "Редактор"

### WebDriver ошибки

**Решение:**
1. Убедитесь, что Chrome/Chromium установлен
2. Проверьте подключение к интернету
3. При первом запуске WebDriver автоматически скачается

## Особенности работы v2.0

### Производительность

- Парсинг 6 блогеров занимает ~15-20 минут
- TikTok: ~2-3 минуты на блогера (4 секунды на видео)
- YouTube: ~30-60 секунд на блогера
- При повторном запуске обновление быстрее (только статистика)

### Дата публикации

**TikTok:**
- Извлекается из JSON данных (`createTime`)
- Если не найдена - пробует извлечь из video ID
- Fallback - текущая дата

**YouTube:**
- Извлекается из `ytInitialData` (`dateText`)
- Парсит форматы: "Jan 15, 2024", "15 янв. 2024"
- Fallback - текущая дата

### Обновление видео

При повторном запуске парсер:
1. Загружает все существующие URL из таблицы
2. Проверяет каждое найденное видео
3. Если URL уже есть → обновляет колонки:
   - D (Дата парсинга)
   - G (Просмотры)
   - H (Лайки)
   - I (Комментарии)
4. Если URL новый → добавляет новую строку

## Структура проекта

```
parcing/
├── main.py                 # Основной скрипт v2.0
├── generate_report.py      # Генератор отчётов (NEW)
├── config.json             # Конфигурация блогеров
├── credentials.json        # Google API credentials (создается вручную)
├── requirements.txt        # Зависимости Python
├── README.md               # Документация
├── parsers/
│   ├── __init__.py
│   ├── youtube_parser.py   # Парсер YouTube v2.1
│   ├── tiktok_parser.py    # Парсер TikTok v2.1
│   └── instagram_parser.py # Парсер Instagram (отключён)
├── utils/
│   ├── __init__.py
│   ├── logger.py           # Настройка логирования
│   └── sheets_manager.py   # Работа с Google Sheets v2.0
└── logs/                   # Логи (создается автоматически)
    └── parser_YYYYMMDD.log
```

## Безопасность

- **НЕ** публикуйте файл `credentials.json` в открытых репозиториях
- Добавьте в `.gitignore`:
  ```
  credentials.json
  logs/
  *.csv
  __pycache__/
  ```
- Service Account имеет минимальные права (только доступ к указанной таблице)

## Roadmap

- [ ] Возврат поддержки Instagram
- [ ] YouTube Shorts поддержка
- [ ] Графики и визуализация роста
- [ ] Telegram бот для уведомлений
- [ ] Поддержка прокси для обхода блокировок
- [ ] API для интеграции с другими сервисами

## Changelog

### v2.0 (2026-01-26)
- Парсинг ВСЕХ видео (до 30 на блогера)
- Автообновление просмотров существующих видео
- Улучшенный парсинг даты публикации
- Итоговые отчёты и статистика
- Экспорт в CSV
- Retry-логика для устойчивости
- Улучшенный обход антибот-защиты YouTube

### v1.0 (2025-01-23)
- Первая версия
- Парсинг последнего видео с платформ
- Базовая интеграция с Google Sheets

## Лицензия

MIT License

## Поддержка

При возникновении проблем:
1. Проверьте логи в директории `logs/`
2. Убедитесь, что все зависимости установлены
3. Проверьте настройки Google Sheets API
4. Проверьте правильность URL в `config.json`
5. Попробуйте запустить парсер ещё раз

---

**Автор:** Claude Code
**Версия:** 2.0
**Дата:** 2026-01-26
